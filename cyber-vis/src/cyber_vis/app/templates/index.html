<!DOCTYPE html>
<html lang="ru">
<head>
        <script>
            // –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ API
            window.CYBER_VIS_API_BASE = 'https://diplom-cyber-security.onrender.com';
            window.CYBER_VIS_WS_URL = 'wss://diplom-cyber-security.onrender.com/ws/monitor';
        </script>

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cyber-Vis Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            min-height: 100vh;
            padding: 20px;
        }
        .container { max-width: 1400px; margin: 0 auto; }
        .header { text-align: center; margin-bottom: 30px; }
        .stats-grid { 
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px; 
            margin-bottom: 30px;
        }
        .stat-card { 
            background: rgba(255, 255, 255, 0.1); 
            padding: 20px; 
            border-radius: 10px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        .stat-value { 
            font-size: 2em; 
            font-weight: bold; 
            margin: 10px 0;
            color: #4cc9f0;
        }
        .chart-container { 
            background: rgba(255, 255, 255, 0.1); 
            padding: 20px; 
            border-radius: 10px;
            margin-bottom: 20px;
            height: 400px;
        }
        .event-log {
            background: rgba(0, 0, 0, 0.3);
            padding: 20px;
            border-radius: 10px;
            max-height: 300px;
            overflow-y: auto;
        }
        .event { 
            padding: 10px; 
            margin-bottom: 5px; 
            background: rgba(255, 255, 255, 0.1);
            border-radius: 5px;
        }
        .event.success { border-left: 4px solid #4ade80; }
        .event.error { border-left: 4px solid #f87171; }
        .event.warning { border-left: 4px solid #fbbf24; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üöÄ Cyber-Vis –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏</h1>
            <p>–í—Å–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∏ –ø–æ–ø—ã—Ç–∫–∏ –≤—Ö–æ–¥–∞ –æ—Ç–æ–±—Ä–∞–∂–∞—é—Ç—Å—è –∑–¥–µ—Å—å</p>
            <div class="status">
                <span id="wsStatus">üî¥ –ù–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–æ</span>
            </div>
        </div>

        <div class="stats-grid" id="statsGrid">
            <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –±—É–¥–µ—Ç –∑–∞–ø–æ–ª–Ω–µ–Ω–∞ JavaScript -->
        </div>

        <div class="chart-container">
            <canvas id="loginChart"></canvas>
        </div>

        <div class="chart-container">
            <canvas id="activityChart"></canvas>
        </div>

        <h2>üìã –ü–æ—Å–ª–µ–¥–Ω–∏–µ —Å–æ–±—ã—Ç–∏—è</h2>
        <div class="event-log" id="eventLog">
            <!-- –°–æ–±—ã—Ç–∏—è –±—É–¥—É—Ç –¥–æ–±–∞–≤–ª—è—Ç—å—Å—è –∑–¥–µ—Å—å -->
        </div>
    </div>

    <script>
        // –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è (–º–æ–∂–Ω–æ –ø–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –ø–µ—Ä–µ–¥ –∑–∞–≥—Ä—É–∑–∫–æ–π —Å–∫—Ä–∏–ø—Ç–∞):
        // window.CYBER_VIS_API_BASE = 'https://your-server.com';
        // window.CYBER_VIS_WS_URL = 'wss://your-server.com/ws/monitor';

        // WebSocket –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ
        let ws = null;
        let loginChart = null;
        let activityChart = null;
        // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –±–∞–∑–æ–≤—ã–µ URL: —Å–Ω–∞—á–∞–ª–∞ –∏—Å–ø–æ–ª—å–∑—É–µ–º –≥–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ (–µ—Å–ª–∏ –∑–∞–¥–∞–Ω—ã),
        // –∏–Ω–∞—á–µ –ø–æ-—É–º–æ–ª—á–∞–Ω–∏—é –∏—Å–ø–æ–ª—å–∑—É–µ–º —Ç–µ–∫—É—â–∏–π —Ö–æ—Å—Ç –∏ –ø—Ä–æ—Ç–æ–∫–æ–ª —Å—Ç—Ä–∞–Ω–∏—Ü—ã.
        const API_BASE = (typeof CYBER_VIS_API_BASE !== 'undefined') ? CYBER_VIS_API_BASE : (location.protocol + '//' + location.host);
        const WS_URL = (typeof CYBER_VIS_WS_URL !== 'undefined') ? CYBER_VIS_WS_URL : ((location.protocol === 'https:') ? 'wss://' + location.host + '/ws/monitor' : 'ws://' + location.host + '/ws/monitor');
        
        // –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ WebSocket
        function connectWebSocket() {
            ws = new WebSocket(WS_URL);
            
            ws.onopen = () => {
                document.getElementById('wsStatus').innerHTML = 'üü¢ –ü–æ–¥–∫–ª—é—á–µ–Ω–æ';
                console.log('‚úÖ –ü–æ–¥–∫–ª—é—á–µ–Ω–æ –∫ WebSocket');
            };
            
            ws.onmessage = (event) => {
                const data = JSON.parse(event.data);
                handleWebSocketMessage(data);
            };
            
            ws.onerror = (error) => {
                console.error('WebSocket –æ—à–∏–±–∫–∞:', error);
                document.getElementById('wsStatus').innerHTML = 'üî¥ –û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è';
            };
            
            ws.onclose = () => {
                document.getElementById('wsStatus').innerHTML = 'üî¥ –û—Ç–∫–ª—é—á–µ–Ω–æ';
                console.log('WebSocket –∑–∞–∫—Ä—ã—Ç, –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ —á–µ—Ä–µ–∑ 5 —Å–µ–∫—É–Ω–¥...');
                setTimeout(connectWebSocket, 5000);
            };
        }
        
        // –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π WebSocket
        function handleWebSocketMessage(data) {
            switch(data.type) {
                case 'init':
                    updateStats(data.data.stats);
                    updateCharts(data.data);
                    addEvent('‚úÖ –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö', 'success');
                    break;
                    
                case 'login_success':
                    addEvent(`‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å ${data.data.username} –≤–æ—à–µ–ª –≤ —Å–∏—Å—Ç–µ–º—É`, 'success');
                    updateStatsAfterEvent('successful_logins');
                    break;
                    
                case 'login_failed':
                    addEvent(`‚ùå –ù–µ—É–¥–∞—á–Ω–∞—è –ø–æ–ø—ã—Ç–∫–∞ –≤—Ö–æ–¥–∞: ${data.data.username}`, 'error');
                    updateStatsAfterEvent('failed_logins');
                    break;
                    
                case 'stats_update':
                    updateStats(data.data);
                    break;
                    
                case 'metric_update':
                    updateMetricChart(data.data);
                    break;
                    
                case 'client_disconnected':
                    addEvent(`üëã –ö–ª–∏–µ–Ω—Ç –æ—Ç–∫–ª—é—á–∏–ª—Å—è`, 'warning');
                    break;
            }
        }
        
        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
        function updateStats(stats) {
            const statsGrid = document.getElementById('statsGrid');
            
            const statsData = [
                { label: '–ê–∫—Ç–∏–≤–Ω—ã–µ —Å–µ—Å—Å–∏–∏', value: stats.active_sessions || 0, icon: 'üë•' },
                { label: '–£—Å–ø–µ—à–Ω—ã—Ö –≤—Ö–æ–¥–æ–≤', value: stats.login_attempts?.successful || 0, icon: '‚úÖ' },
                { label: '–ù–µ—É–¥–∞—á–Ω—ã—Ö –ø–æ–ø—ã—Ç–æ–∫', value: stats.login_attempts?.failed || 0, icon: '‚ùå' },
                { label: '–í—Å–µ–≥–æ –ø–æ–ø—ã—Ç–æ–∫', value: stats.login_attempts?.total || 0, icon: 'üìä' },
                { label: '–£–Ω–∏–∫–∞–ª—å–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π', value: stats.unique_users || 0, icon: 'üë§' },
                { label: '–ó–∞ 24 —á–∞—Å–∞', value: stats.last_24h?.total || 0, icon: 'üïê' }
            ];
            
            statsGrid.innerHTML = statsData.map(stat => `
                <div class="stat-card">
                    <div class="stat-icon">${stat.icon}</div>
                    <div class="stat-label">${stat.label}</div>
                    <div class="stat-value">${stat.value}</div>
                </div>
            `).join('');
        }
        
        function updateStatsAfterEvent(type) {
            // –ó–¥–µ—Å—å –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –ª–æ–≥–∏–∫—É –¥–ª—è –∏–Ω–∫—Ä–µ–º–µ–Ω—Ç–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
            console.log(`–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∞: ${type}`);
        }
        
        // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Å–æ–±—ã—Ç–∏—è –≤ –ª–æ–≥
        function addEvent(message, type = 'info') {
            const eventLog = document.getElementById('eventLog');
            const eventDiv = document.createElement('div');
            eventDiv.className = `event ${type}`;
            eventDiv.innerHTML = `
                <span style="color: #aaa">[${new Date().toLocaleTimeString()}]</span>
                ${message}
            `;
            eventLog.prepend(eventDiv);
            
            // –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–æ–±—ã—Ç–∏–π
            while (eventLog.children.length > 50) {
                eventLog.removeChild(eventLog.lastChild);
            }
        }
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –≥—Ä–∞—Ñ–∏–∫–æ–≤
        function initCharts() {
            const loginCtx = document.getElementById('loginChart').getContext('2d');
            loginChart = new Chart(loginCtx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: '–ü–æ–ø—ã—Ç–∫–∏ –≤—Ö–æ–¥–∞ –≤ —á–∞—Å',
                        data: [],
                        borderColor: 'rgb(75, 192, 192)',
                        tension: 0.1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: '–ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –≤—Ö–æ–¥–∞ –ø–æ –≤—Ä–µ–º–µ–Ω–∏'
                        }
                    }
                }
            });
            
            const activityCtx = document.getElementById('activityChart').getContext('2d');
            activityChart = new Chart(activityCtx, {
                type: 'doughnut',
                data: {
                    labels: ['–£—Å–ø–µ—à–Ω—ã–µ', '–ù–µ—É–¥–∞—á–Ω—ã–µ'],
                    datasets: [{
                        data: [0, 0],
                        backgroundColor: [
                            'rgba(75, 192, 192, 0.8)',
                            'rgba(255, 99, 132, 0.8)'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: '–°–æ–æ—Ç–Ω–æ—à–µ–Ω–∏–µ –ø–æ–ø—ã—Ç–æ–∫ –≤—Ö–æ–¥–∞'
                        }
                    }
                }
            });
        }
        
        function updateCharts(data) {
            if (loginChart && activityChart) {
                // –û–±–Ω–æ–≤–ª—è–µ–º –≥—Ä–∞—Ñ–∏–∫–∏ –Ω–∞ –æ—Å–Ω–æ–≤–µ –ø–æ–ª—É—á–µ–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
                const success = data.stats?.login_attempts?.successful || 0;
                const failed = data.stats?.login_attempts?.failed || 0;
                
                activityChart.data.datasets[0].data = [success, failed];
                activityChart.update();
            }
        }
        
        function updateMetricChart(metricData) {
            // –ó–¥–µ—Å—å –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≥—Ä–∞—Ñ–∏–∫–æ–≤ –º–µ—Ç—Ä–∏–∫
            console.log('–ú–µ—Ç—Ä–∏–∫–∞ –ø–æ–ª—É—á–µ–Ω–∞:', metricData);
        }
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        window.addEventListener('load', () => {
            initCharts();
            connectWebSocket();
            
            // –ü–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ (fallback)
            setInterval(() => {
                if (ws && ws.readyState === WebSocket.OPEN) {
                    ws.send(JSON.stringify({ type: 'ping' }));
                }
            }, 30000);
        });
    </script>
</body>
</html>